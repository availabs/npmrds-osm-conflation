#!/bin/bash

# Found a planet-osm mirror that hosts the same planet version used by SharedStreets (181224):
#   https://wiki.openstreetmap.org/wiki/Planet.osm#Planet.osm_mirrors
#   https://ftpmirror.your.org/pub/openstreetmap/pbf/

set -Ee

print_usage()
{
  (>&2 cat << _EOF_
NAME: download_osm_planet

SYNOPSIS:
    OSM_PLANET_VERSION=version OSM_DATA_DIR=dir download_osm_planet

DESCRIPTION:
  Download the specified OSM planet version from https://ftpmirror.your.org/pub/openstreetmap/pbf into the specified directory.

  Requires the following two ENV variables to be set:
      * OSM_PLANET_VERSION
      * OSM_DATA_DIR
_EOF_
  )
}

if [ -z "$OSM_DATA_DIR" ] || [ -z "$OSM_PLANET_VERSION" ]; then
  print_usage
  exit 1
fi

source ./set_convention_vars

# clean up the download file.
warn_of_potential_file_corruption() {
  (>&2 cat << _EOF_
WARNING: The OSM planet file at $OSM_PLANET_FILE_PATH is possibly corrupted.
         It was not deleted. Inspect it carefully before using it.

_EOF_
  )
  exit 1
}
# If this file encounters an ERROR, print potential file corruption warning.
trap warn_of_potential_file_corruption ERR

download_osm_planet() {
  if [ ! -f "$OSM_PLANET_FILE_PATH" ]; then
    mkdir -p "$( dirname "$OSM_PLANET_FILE_PATH" )"
    (>&2 echo "Downloading $OSM_PLANET_VERSION_URL")
    curl "$OSM_PLANET_VERSION_URL" > "$OSM_PLANET_FILE_PATH"
  else
    (>&2 echo "WARNING: $OSM_PLANET_FILE_PATH already exists. Skipping download.")
  fi
}

check_downloaded_osm_planet_md5sum() {
  OSM_PLANET_MD5SUM_FILE_NAME="$OSM_PLANET_FILE_NAME.md5"
  OSM_PLANET_MD5SUM_FILE_PATH="$OSM_PLANET_FILE_PATH.md5"

  curl --silent "$OSM_PLANET_VERSION_MD5SUM_URL" > "$OSM_PLANET_MD5SUM_FILE_PATH"

  pushd "$( dirname "$OSM_PLANET_FILE_PATH" )" >/dev/null

  if ! md5sum --status -c "$OSM_PLANET_MD5SUM_FILE_NAME"; then
    (>&2 echo "ERROR: md5sum match fail for downloaded OSM planet file version.")
    ( exit 1 ) # non-zero exit within subshell triggers ERR trap
  fi

  popd >/dev/null
}

### MAIN
download_osm_planet
check_downloaded_osm_planet_md5sum
