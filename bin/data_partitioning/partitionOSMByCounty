#!/bin/bash

set -e
set -a

if [ "$#" -ne 2 ]; then
  (>&2 echo 'USAGE: You must provide two positional CLI argument:')
  (>&2 echo '         1st: the path to the OSM file')
  (>&2 echo '         2nd: the output directory')
  exit 1
fi

OSM_FILE="$( realpath "$1" )"

mkdir -p "$2"
OUT_DIR="$( realpath "$2" )"


pushd "$( dirname "${BASH_SOURCE[0]}" )/" >/dev/null

# source the database connection config.
. ../.env

SQL="
  SELECT DISTINCT
      LOWER(REPLACE(county, ' ', '_'))
    FROM public.npmrds_extended_shapefile
    ORDER BY 1
  ;
"

psql -tA -c "$SQL" |
  while read -r county; do
    ./createCountyOSMSubset "$OSM_FILE" "${OUT_DIR}/${county}.osm" "$county" xml
  done

popd >/dev/null
