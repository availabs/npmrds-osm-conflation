#!/bin/bash

set -e

if [ "$#" -ne 1 ]; then
  (>&2 echo "ERROR: You must specify the county name as the 1st and only CLI argument.")
  exit 1
fi

COUNTY="${1,,}"

pushd "$( dirname "${BASH_SOURCE[0]}" )/" >/dev/null

# source the database connection config.
. ../../.env

SQL="
  SELECT
      ST_ConvexHull(
        ST_Collect(
          wkb_geometry
        )
      ) AS bpoly
    FROM public.npmrds_extended_shapefile
    WHERE (
      LOWER(county) = '$COUNTY'
    )
  ;
"

echo "$COUNTY
tmc_convex_hull
$(
  ogr2ogr -s_srs EPSG:4326 -t_srs EPSG:4326 -f GeoJSON /vsistdout/ \
      "PG:host=${PGHOST} port=${PGPORT} user=${PGUSER} dbname=${PGDATABASE} password=${PGPASSWORD}" \
      -sql "$SQL" |
    jq '.features|map(.geometry.coordinates)|flatten[]' |
    paste -s -d' \n' |
    column -t |
    sed 's/^/  /'
)
END"

popd >/dev/null

