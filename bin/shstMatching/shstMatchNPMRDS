#!/bin/bash

set -e
set -a

if [ "$#" -ne 2 ]; then
  (>&2 echo 'USAGE: You must provide two positional CLI argument:')
  (>&2 echo '         1st: the input GeoJSON file path')
  (>&2 echo '         2nd: the output directory path')
  exit 1
fi

if [ ! -f "$1" ]; then
  (>&2 echo "ERROR: No file found at at $1")
  exit 1
fi

mkdir -p "$2"

INF="$( realpath "$1" )"
OUT_DIR="$( readlink -f "$2" )"

# https://stackoverflow.com/a/965072
INF_FILENAME="$( basename -- "$INF" )"
OUTF_BASE="${INF_FILENAME%.*}"

pushd "$( dirname "${BASH_SOURCE[0]}" )/../../" >/dev/null

outf="$OUT_DIR/${OUTF_BASE}.motorways.geojson"
echo "$outf"

# Because these counties crashe the matcher,
#  and the matcher doesn't clean up after it crashes
#  thereby breaking the surface-streets matching.
if ! [[ "${OUTF_BASE,,}" =~ (franklin|hamilton|wyoming) ]]; then
  ./node_modules/.bin/shst match "$INF" \
    --match-motorway-only \
    --snap-intersections \
    --follow-line-direction \
    --match-car \
    --tile-hierarchy=8 \
    --out="$outf"
fi

outf="$OUT_DIR/${OUTF_BASE}.surface-streets.geojson"
echo "$outf"

./node_modules/.bin/shst match "$INF" \
  --match-surface-streets-only \
  --snap-intersections \
  --follow-line-direction \
  --match-car \
  --tile-hierarchy=8 \
  --out="$outf"

popd >/dev/null
